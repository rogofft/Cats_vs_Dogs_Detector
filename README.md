## Cats vs Dogs Detector
### Описание
Пайплайн для разработки нейросетевых моделей детекторов кошек и собак на изображении на фреймворке PyTorch.
По условию поставленной задачи на картинке присутствует лишь одно животное, мордочку которого необходимо детектировать.

Здесь разработаны и представлены 4 модели:
* **baseline** - простая модель, основанная на архитектуре ResNet18, с одним регрессионным выходным слоем.
* **transfer_inception_v3** - предобученная модель inception_v3 с заменой классификатора на один регрессионный выходной слой.
* **transfer_resnet50** - предобученная модель ResNet50 с заменой классификатора на два полносвязных слоя.
* **best_detector** - предобученная модель ResNet50 с заменой классификатора на два независимых слоя - классификации и 
предсказания 7x7x3 якорей (т.к. по условию задачи в кадре всего одно животное, выбирается тот якорь, у которого 
предсказанная вероятность нахождения объекта внутри него максимальная).

Метриками качества моделей выбраны mIoU и accuracy. Датасет содержал 1037 изображений кошек и 2348 изображений собак, 
всего 3385. Одно изображение из датасета в формате grayscale не включалось в train и test выборки. К каждому файлу 
изображения прилагается файл `.txt` с 5 цифрами (метка класса, x1, y1, x2, y2), где метка класса 1 соответствует кошке, 
 2 - собаке, x1, y1, x2, y2 - координаты bounding box'a мордочки животного. Получившиеся 
результаты обученных моделей представлены ниже:

Модель | Время инференса, мс | размер train | размер test | mIoU, % | accuracy, % 
--- | --- | --- | --- | --- | ---
baseline | 9.33 | 2369 | 1015 | 48.21 | 81.67
transfer_inception_v3 | 29.25 | 2369 | 1015 | 45.97 | 99.80
transfer_resnet50 | 16.11 | 2369 | 1015 | 67.12 | 99.41
best_detector | 18.45 | 2369 | 1015 | 79.78 | 99.51

Все модели были обучены на одинаковых данных (фиксированный seed у генератора рандомной перестановки индексов). 
70% датасета - train, 30% - test.

Время инференса измерялось на видеокарте GeForce GTX 970.

### Установка
Создайте виртуальное окружение при помощи команды `virtualenv venv` в папке с проектом.

Запустите виртуальное окружение virtualenv при помощи `venv\Scripts\activate`

Установите требуемые библиотеки командой `pip install -r "requirements.txt"`

Для поддержки вычислений при помощи ядер Nvidia Cuda необходимо установить CUDA Toolkit 
(https://developer.nvidia.com/cuda-11.1.0-download-archive) 
### Обучение
Для обучения модели необходимо запустить скрипт `bin/train.py` и в качестве параметра передать путь к файлу 
конфигурации %model_name%.yaml, в котором описаны 2 параметра:
* model_config - путь к yaml файлу конфигурации модели
* data_config - путь к yaml файлу конфигурации данных

В файле конфигурации модели описаны архитектура сети, алгоритм обучения, функция потерь, оптимизаторы и т.д. Все 
параметры передаются функциям-фабрикам, которые возвращают соответствующие модели/функции.

Аналогично, в файле конфигурации данных описываются путь к датасету, правила отбора файлов, методы извлечения данных, 
аугментации, размер валидационной выборки, размер батча и т.д.

В итоге получаем единый интерфейс обучения модели, а вся конфигурация описывается yaml файлами.

Для добавления новых пользовательских функций/архитектур/правил/аугментаций достаточно дополнить соответствующую 
функцию-фабрику новым названием (использующимся в yaml файле) и добавить соответствующую функцию/класс, которую фабрика 
будет возвращать.

По умолчанию, обученная модель будет сохранена в папку `model`.
Графики loss, mIoU, accuracy в зависимости от эпохи обучения будут сохранены в `plots/train_plots.png`

### Валидация
Для валидации полученной модели необходимо запустить скрипт `bin/predict.py` со следующими параметрами:
* путь к файлу конфигурации %model_name%.yaml
* путь к файлу с весами обученной модели, полученному при обучении

По завершении работы скрипта в папке `predictions` будут созданы файлы `%filename%.txt` - результаты предсказания 
класса и bbox'а моделью для соответствующего файла, а также файл `__netinfo.txt` с именем модели, временем инференса, 
количеством данных в train и test выборках.

Далее необходимо запустить скрипт `bin/evaluate_predicts.py` который посчитает получившиеся метрики качества и дополнит 
ими файл `predictions/__netinfo.txt`. В качестве параметров необходимо передать:
* путь к датасету
* путь к папке `predictions`

### Просто посмотреть как работает
Для демонстрации работы модели необходимо запустить скрипт `bin/demo.py` со следующими параметрами:
* путь к файлу конфигурации %model_name%.yaml
* путь к файлу с весами обученной модели
* путь к изображению в формате `.jpg` (желательно, чтобы на нём была кошка или собака)

Т.к. на гитхабе ограничение по размеру файлов, оставляю ссылку на предобученную модель best_detector'а на google drive:
https://drive.google.com/drive/folders/1q1xBPCvh-bHk7k-r7T0YWtMxCI5C1mA1?usp=sharing
